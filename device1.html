  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Device 1 - Air Quality Monitor</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
      <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
      <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      />
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
      <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBawdAvivw24kEJJcZ8pjOVKLnUCPlWxig",
          authDomain: "project-aqi-43620.firebaseapp.com",
          projectId: "project-aqi-43620",
          storageBucket: "project-aqi-43620.appspot.com",
          messagingSenderId: "853048957452",
          appId: "1:853048957452:web:51b30fd41cab4658cdec29",
          measurementId: "G-MVKRVKVVB0",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Use relative path or environment variable for socket.io server URL
        const socket = io();

        document.addEventListener("DOMContentLoaded", function () {
          // Real-time listener for location updates
          db.collection("devices").doc("device1").onSnapshot((doc) => {
            if (doc.exists) {
              const location = doc.data().location;
              const locationElem = document.querySelector(".device1-location");
              if (locationElem) {
                locationElem.textContent = location || "Not Set";
              }
            } else {
              console.log("No such document!");
            }
          }, (error) => {
            console.error("Error listening to device1:", error);
          });

          const logoutBtn = document.getElementById("logoutBtn");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              if (confirm("Are you sure you want to logout?")) {
                try {
                  logoutBtn.innerHTML =
                    '<i class="fas fa-spinner fa-spin mr-2"></i> Logging out...';

                  await auth.signOut();
                  localStorage.removeItem("user");
                  window.location.href = "signin.html";
                } catch (error) {
                  console.error("Logout error:", error);
                  alert("Logout failed. Please try again.");
                }
              }
            });
          }
        });
      </script>
      <style>
        .chart-container {
          width: 100%;
          height: 300px;
        }
        .device-card {
          transition: all 0.3s ease;
        }
        .device-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        #sidebar:hover .nav-text {
          display: inline-block;
          opacity: 1;
          transition: opacity 0.3s ease-in-out;
        }
        #sidebar .nav-text {
          display: none;
          opacity: 1;
          transition: opacity 0.3s ease-in-out;
        }
        .gauge-container {
          width: 280px;
          height: 280px;
        }
      </style>
  </head>
  <body class="bg-gray-100">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="bg-blue-800 text-white w-16 hover:w-64 p-4 transition-all duration-300 ease-in-out flex flex-col overflow-hidden"
      >
        <div class="flex justify-between items-center mb-8">
          <img src="logo.png" alt="aqi" width="80px" height="80px" />
          <button onclick="toggleSidebar()" class="text-white focus:outline-none"></button>
        </div>
        <nav class="flex-1">
          <!-- Dashboard -->
          <a
            href="dashboard.html"
            class="flex items-center py-2 px-4 rounded hover:bg-blue-700 mb-2"
          >
            <i class="fas fa-tachometer-alt mr-2 w-6 text-center"></i>
            <span class="nav-text">Dashboard</span>
          </a>

          <!-- Devices -->
          <div class="mb-2">
            <div
              class="flex items-center py-2 px-4 rounded hover:bg-blue-700 cursor-pointer"
              onclick="toggleSubmenu('devices')"
            >
              <i class="fas fa-microchip mr-2 w-6 text-center"></i>
              <span class="nav-text">Devices</span>
              <i class="fas fa-chevron-down ml-auto nav-text text-xs"></i>
            </div>
            <div id="devices-submenu" class="pl-8 flex flex-col">
              <a href="device1.html" class="block py-2 hover:text-blue-200 nav-text"
                >Device 1</a
              >
              <a href="device2.html" class="block py-2 hover:text-blue-200 nav-text"
                >Device 2</a
              >
            </div>
          </div>

          <!-- Notifications -->
          <a
            href="notifications.html"
            class="flex items-center py-2 px-4 rounded hover:bg-blue-700 mb-2"
          >
            <i class="fas fa-bell mr-2 w-6 text-center"></i>
            <span class="nav-text">Notifications</span>
          </a>

          <!-- Settings -->
          <div class="mb-2">
            <div
              class="flex items-center py-2 px-4 rounded hover:bg-blue-700 cursor-pointer"
              onclick="toggleSubmenu('settings')"
            >
              <i class="fas fa-cog mr-2 w-6 text-center"></i>
              <span class="nav-text">Settings</span>
              <i class="fas fa-chevron-down ml-auto nav-text text-xs"></i>
            </div>
            <div id="settings-submenu" class="pl-8 hidden">
              <a
                href="notification-settings.html"
                class="block py-2 hover:text-blue-200 nav-text"
                >Notification Settings</a
              >
              <a
                href="device-settings.html"
                class="block py-2 hover:text-blue-200 nav-text"
                >Device Settings</a
              >
              <a
                href="user-preferences.html"
                class="block py-2 hover:text-blue-200 nav-text"
                >User Preferences</a
              >
            </div>
          </div>

          <!-- Help & Support -->
          <div class="mb-2">
            <div
              class="flex items-center py-2 px-4 rounded hover:bg-blue-700 cursor-pointer"
              onclick="toggleSubmenu('help')"
            >
              <i class="fas fa-question-circle mr-2 w-6 text-center"></i>
              <span class="nav-text">Help & Support</span>
              <i class="fas fa-chevron-down ml-auto nav-text text-xs"></i>
            </div>
            <div id="help-submenu" class="pl-8 hidden">
              <a
                href="user-guide.html"
                class="block py-2 hover:text-blue-200 nav-text"
                >User Guide</a
              >
              <a
                href="customer-support.html"
                class="block py-2 hover:text-blue-200 nav-text"
                >Customer Support</a
              >
            </div>
          </div>

          <!-- Logout -->
          <a
            href="/api/auth/logout"
            id="logoutBtn"
            class="flex items-center py-2 px-4 rounded hover:bg-blue-700 mt-auto"
          >
            <i class="fas fa-sign-out-alt mr-2 w-6 text-center"></i>
            <span class="nav-text">Logout</span>
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="flex-1 p-8 overflow-auto">
        <div class="flex justify-between items-center mb-6">
          <!-- Device Card -->
          <div class="device-card bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
              <h2 class="text-xl font-semibold">Device 1</h2>
              <p
                class="ml-2 text-gray-700 bg-gray-200 px-2 py-1 rounded-md device1-location"
              >
                Ugac Norte
              </p>
            </div>
          </div>

          <!-- Date Selector -->
          <div>
            <input type="date" id="dateSelect" class="border border-gray-300 rounded px-3 py-2" />
          </div>
        </div>

        <!-- PM Chart -->
        <div class="mb-6">
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4">Particulate Matter (PM)</h3>
            <div class="chart-container">
              <canvas id="pmChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Combined Gas Chart -->
        <div class="mb-6">
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4">Gas Concentrations</h3>
            <div class="chart-container">
              <canvas id="gasChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Gauge Charts -->
        <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
          <!-- AQI Gauge -->
          <div class="bg-white p-4 rounded-lg shadow w-full md:w-1/3">
            <h3 class="text-lg font-semibold mb-4 text-center">AQI</h3>
            <div class="flex justify-center">
              <div id="aqiGauge" class="gauge-container"></div>
            </div>
          </div>

          <!-- Temperature Gauge -->
          <div class="bg-white p-4 rounded-lg shadow w-full md:w-1/3">
            <h3 class="text-lg font-semibold mb-4 text-center">Temperature</h3>
            <div class="flex justify-center">
              <div id="tempGauge" class="gauge-container"></div>
            </div>
          </div>

          <!-- Humidity Gauge -->
          <div class="bg-white p-4 rounded-lg shadow w-full md:w-1/3">
            <h3 class="text-lg font-semibold mb-4 text-center">Humidity</h3>
            <div class="flex justify-center">
              <div id="humidityGauge" class="gauge-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize charts variables
      let pmChart, gasChart;
      let aqiChart, tempGauge, humidityGauge;

      // Compute AQI based on pm2.5, pm10, co, and no2 values
      function computeAQI(pm25, pm10, co, no2) {
        // Simple weighted average approach (weights can be adjusted)
        // Normalize each pollutant to 0-500 scale (example max values)
        const pm25Max = 500;
        const pm10Max = 500;
        const coMax = 50; // ppm
        const no2Max = 200; // ppb

        const pm25Index = Math.min((pm25 / pm25Max) * 500, 500);
        const pm10Index = Math.min((pm10 / pm10Max) * 500, 500);
        const coIndex = Math.min((co / coMax) * 500, 500);
        const no2Index = Math.min((no2 / no2Max) * 500, 500);

        // Weighted sum (weights sum to 1)
        const aqi = 0.4 * pm25Index + 0.3 * pm10Index + 0.2 * coIndex + 0.1 * no2Index;
        return Math.min(Math.max(aqi, 0), 500);
      }

      // Create ApexCharts gauge options
      function createGaugeOptions(name, value, max) {
        return {
          chart: {
            height: 280,
            type: 'radialBar',
            offsetY: -10,
            sparkline: { enabled: true }
          },
          plotOptions: {
            radialBar: {
              startAngle: -90,
              endAngle: 90,
              track: {
                background: '#e7e7e7',
                strokeWidth: '97%',
                margin: 5,
                dropShadow: { enabled: false }
              },
              dataLabels: {
                name: { show: true, fontSize: '16px', color: '#374151' },
                value: { show: true, fontSize: '22px', color: '#111827', formatter: val => val.toFixed(1) }
              }
            }
          },
          colors: [getColorForValue(value / max)],
          series: [value],
          labels: [name]
        };
      }

      // Determine color based on value thresholds
      function getColorForValue(percent) {
        if (percent < 0.3) return "#10B981"; // Green
        if (percent < 0.6) return "#F59E0B"; // Yellow
        return "#EF4444"; // Red
      }

      // Initialize charts
      function initCharts() {
        // PM Chart - combined PM1, PM2.5, PM10
        const pmCtx = document.getElementById("pmChart").getContext("2d");
        pmChart = new Chart(pmCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              { label: "PM1.0 (µg/m³)", borderColor: "#EF4444", backgroundColor: "#EF444420", data: [], fill: true, tension: 0.3 },
              { label: "PM2.5 (µg/m³)", borderColor: "#F59E0B", backgroundColor: "#F59E0B20", data: [], fill: true, tension: 0.3 },
              { label: "PM10 (µg/m³)", borderColor: "#10B981", backgroundColor: "#10B98120", data: [], fill: true, tension: 0.3 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Concentration (µg/m³)" } },
              x: { title: { display: true, text: "Time" } }
            }
          }
        });

        // Gas Chart - CO and NO2
        const gasCtx = document.getElementById("gasChart").getContext("2d");
        gasChart = new Chart(gasCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              { label: "CO (ppm)", borderColor: "#EF4444", backgroundColor: "#EF444420", data: [], fill: true, tension: 0.3 },
              { label: "NO₂ (ppb)", borderColor: "#8B5CF6", backgroundColor: "#8B5CF620", data: [], fill: true, tension: 0.3 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Concentration" } },
              x: { title: { display: true, text: "Time" } }
            }
          }
        });

        // ApexCharts radial gauges for Temperature and Humidity
        aqiChart = echarts.init(document.getElementById("aqiGauge"));
        aqiChart.setOption({
          series: [
            {
              name: "AQI",
              type: "gauge",
              startAngle: 180,
              endAngle: 0,
              min: 0,
              max: 500,
              splitNumber: 5,
              axisLine: {
                lineStyle: {
                  width: 10,
                  color: [
                    [0.3, "#10B981"],
                    [0.6, "#F59E0B"],
                    [1, "#EF4444"],
                  ],
                },
              },
              pointer: {
                length: "70%",
                width: 6,
              },
              detail: {
                formatter: "{value}",
                fontSize: 24,
                color: "#111827",
              },
              data: [{ value: 0, name: "AQI" }],
            },
          ],
        });

        // Use echarts for tempGauge and humidityGauge with similar config as AQI gauge
        tempGauge = echarts.init(document.getElementById("tempGauge"));
        tempGauge.setOption({
          series: [
            {
              name: "Temperature",
              type: "gauge",
              startAngle: 180,
              endAngle: 0,
              min: 0,
              max: 50,
              splitNumber: 5,
              axisLine: {
                lineStyle: {
                  width: 10,
                  color: [
                    [0.3, "#10B981"],
                    [0.6, "#F59E0B"],
                    [1, "#EF4444"],
                  ],
                },
              },
              pointer: {
                length: "70%",
                width: 6,
              },
              detail: {
                formatter: "{value} °C",
                fontSize: 24,
                color: "#111827",
              },
              data: [{ value: 0, name: "Temperature" }],
            },
          ],
        });

        humidityGauge = echarts.init(document.getElementById("humidityGauge"));
        humidityGauge.setOption({
          series: [
            {
              name: "Humidity",
              type: "gauge",
              startAngle: 180,
              endAngle: 0,
              min: 0,
              max: 100,
              splitNumber: 5,
              axisLine: {
                lineStyle: {
                  width: 10,
                  color: [
                    [0.3, "#10B981"],
                    [0.6, "#F59E0B"],
                    [1, "#EF4444"],
                  ],
                },
              },
              pointer: {
                length: "70%",
                width: 6,
              },
              detail: {
                formatter: "{value} %",
                fontSize: 24,
                color: "#111827",
              },
              data: [{ value: 0, name: "Humidity" }],
            },
          ],
        });
      }

      // Generate time labels for charts based on selected date
      function generateTimeLabelsForDay(dateStr) {
        let labels = [];
        for (let hour = 0; hour < 24; hour++) {
          labels.push(hour.toString().padStart(2, '0') + ":00");
        }
        return labels;
      }

      // Fetch data from backend using Flux query for a specific day
      async function fetchDataForDay(dateStr) {
        // Construct start and stop ISO strings for the day
        const start = new Date(dateStr + "T00:00:00Z");
        const stop = new Date(dateStr + "T23:59:59Z");

      const fluxQuery = `
        from(bucket: "aqi_project")
          |> range(start: ${start.toISOString()}, stop: ${stop.toISOString()})
          |> filter(fn: (r) => r._measurement == "air_quality" and r.device == "device1")
          |> aggregateWindow(every: 1h, fn: mean, createEmpty: true)
          |> pivot(rowKey:["_time"], columnKey: ["_field"], valueColumn: "_value")
          |> keep(columns: ["_time", "CO", "NO2", "Temperature", "Humidity", "PM1_0", "PM2_5", "PM10"])
          |> sort(columns: ["_time"])
      `;


        try {
          const response = await fetch('/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/vnd.flux' },
            body: fluxQuery,
          });

          if (!response.ok) {
            console.error('Failed to fetch data:', response.statusText);
            return null;
          }

          const csvText = await response.text();
          console.log("Raw CSV response:", csvText);
          const parsedData = parseCSVData(csvText);
          console.log("Parsed data:", parsedData);
          return parsedData;
        } catch (error) {
          console.error('Error fetching data:', error);
          return null;
        }
      }

      // Parse CSV data from InfluxDB into usable format
      function parseCSVData(csvText) {
        // Use a simple CSV parser that handles quoted fields and commas inside quotes
        function parseCSVLine(line) {
          const result = [];
          let current = '';
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current);
          return result;
        }

        const lines = csvText.trim().split('\n');

        const data = {
          time: [],
          pm1: [],
          pm2_5: [],
          pm10: [],
          co: [],
          no2: [],
          temperature: [],
          humidity: []
        };

        // Fixed indices based on known CSV format
        const timeIndex = 2;
        const coIndex = 3;
        const no2Index = 4;
        const tempIndex = 5;
        const humIndex = 6;
        const pm1Index = 7;
        const pm2_5Index = 8;
        const pm10Index = 9;

        // Parse data lines until next comment or end
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('#')) continue;
          const values = parseCSVLine(lines[i]);

          // Defensive check for missing columns
          data.time.push(values[timeIndex] || '');
          data.co.push(parseFloat(values[coIndex]) || 0);
          data.no2.push(parseFloat(values[no2Index]) || 0);
          data.temperature.push(parseFloat(values[tempIndex]) || 0);
          data.humidity.push(parseFloat(values[humIndex]) || 0);
          data.pm1.push(parseFloat(values[pm1Index]) || 0);
          data.pm2_5.push(parseFloat(values[pm2_5Index]) || 0);
          data.pm10.push(parseFloat(values[pm10Index]) || 0);
        }
        return data;
      }

        // Update charts with new data
        function updateCharts(data, range) {
          const labels = generateTimeLabelsForDay(range);
          pmChart.data.labels = labels;
          pmChart.data.datasets[0].data = data.pm1;
          pmChart.data.datasets[1].data = data.pm2_5;
          pmChart.data.datasets[2].data = data.pm10;
          pmChart.update();

          gasChart.data.labels = labels;
          gasChart.data.datasets[0].data = data.co;
          gasChart.data.datasets[1].data = data.no2;
          gasChart.update();

          // Compute AQI from pollutants
          const latestPm25 = data.pm2_5.length > 0 ? data.pm2_5[data.pm2_5.length - 1] : 0;
          const latestPm10 = data.pm10.length > 0 ? data.pm10[data.pm10.length - 1] : 0;
          const latestCo = data.co.length > 0 ? data.co[data.co.length - 1] : 0;
          const latestNo2 = data.no2.length > 0 ? data.no2[data.no2.length - 1] : 0;
          const latestAqi = computeAQI(latestPm25, latestPm10, latestCo, latestNo2);

          aqiChart.setOption({
            series: [{ data: [{ value: latestAqi, name: "AQI" }] }]
          });

          // Fix: Ensure temperature and humidity gauges update correctly with latest values
          const latestTempRaw = data.temperature.length > 0 ? data.temperature[data.temperature.length - 1] : 0;
          const latestHumidityRaw = data.humidity.length > 0 ? data.humidity[data.humidity.length - 1] : 0;

          // Clamp temperature between 0 and 50
          const latestTemp = Math.min(Math.max(latestTempRaw, 0), 50);
          // Clamp humidity between 0 and 100
          const latestHumidity = Math.min(Math.max(latestHumidityRaw, 0), 100);

          tempGauge.setOption({
            series: [{ data: [{ value: latestTemp, name: "Temperature" }] }]
          });

          humidityGauge.setOption({
            series: [{ data: [{ value: latestHumidity, name: "Humidity" }] }]
          });

          const lastUpdatedElem = document.getElementById("lastUpdated");
          if (lastUpdatedElem) {
            lastUpdatedElem.textContent = new Date().toLocaleString();
          }
        }

      // Handle date change
      document.getElementById("dateSelect").addEventListener("change", async (e) => {
        const dateStr = e.target.value;
        if (!dateStr) return;
        const data = await fetchDataForDay(dateStr);
        if (data) updateCharts(data, dateStr);
      });

      // Initial load
      document.addEventListener("DOMContentLoaded", async () => {
        initCharts();
        // Set date input to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("dateSelect").value = today;
        const data = await fetchDataForDay(today);
        if (data) updateCharts(data, today);
      });

      // Real-time updates via socket.io
      socket.on("newData", (data) => {
        if (!data || data.deviceId !== "device1") return;

        // Parse data fields to numbers
        const co = parseFloat(data.co) || 0;
        const no2 = parseFloat(data.no2) || 0;
        const temperature = parseFloat(data.temperature) || 0;
        const humidity = parseFloat(data.humidity) || 0;
        const pm1_0 = parseInt(data.pm1_0) || 0;
        const pm2_5 = parseInt(data.pm2_5) || 0;
        const pm10 = parseInt(data.pm10) || 0;

        // Update gauges with latest values
        aqiChart.setOption({
          series: [{ data: [{ value: pm2_5, name: "AQI" }] }],
        });
        // Fix: Update temperature and humidity gauges with real-time values
        tempGauge.setOption({
          series: [{ data: [{ value: temperature, name: "Temperature" }] }]
        });
        humidityGauge.setOption({
          series: [{ data: [{ value: humidity, name: "Humidity" }] }]
        });

        // Append new data points to charts
        // Normalize time label to HH:MM for comparison
        const now = new Date();
        const nowLabel = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

        // Avoid duplicate time labels
        if (pmChart.data.labels[pmChart.data.labels.length - 1] !== nowLabel) {
          // PM Chart update
          pmChart.data.labels.push(nowLabel);
          pmChart.data.datasets[0].data.push(pm1_0);
          pmChart.data.datasets[1].data.push(pm2_5);
          pmChart.data.datasets[2].data.push(pm10);
          if (pmChart.data.labels.length > 50) {
            pmChart.data.labels.shift();
            pmChart.data.datasets.forEach((ds) => ds.data.shift());
          }
          pmChart.update();

          // Gas Chart update
          gasChart.data.labels.push(nowLabel);
          gasChart.data.datasets[0].data.push(co);
          gasChart.data.datasets[1].data.push(no2);
          if (gasChart.data.labels.length > 50) {
            gasChart.data.labels.shift();
            gasChart.data.datasets.forEach((ds) => ds.data.shift());
          }
          gasChart.update();
        }

        const lastUpdatedElem = document.getElementById("lastUpdated");
        if (lastUpdatedElem) {
          lastUpdatedElem.textContent = new Date().toLocaleString();
        }
      });
    </script>
  </body>
  </html>
